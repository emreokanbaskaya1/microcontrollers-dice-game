#include <16F877A.h>
#fuses XT, NOWDT, NOPROTECT, NOBROWNOUT, NOLVP, NOPUT, NOWRT, NODEBUG, NOCPD
#use delay(clock=4M)
#include <lcd420.c>

// LCD Pin Tanýmlarý
#define LCD_RS_PIN PIN_B1
#define LCD_RW_PIN PIN_B2
#define LCD_E_PIN  PIN_B0
#define LCD_D4_PIN PIN_B4
#define LCD_D5_PIN PIN_B5
#define LCD_D6_PIN PIN_B6
#define LCD_D7_PIN PIN_B7

// Global deðiþkenler
int oyuncu1_zarlar[3] = {0}, oyuncu2_zarlar[3] = {0};
int oyuncu1_toplam = 0, oyuncu2_toplam = 0;
int zar_sayisi = 0;

// Timer0 ile rastgele zar atýþý (1-6 arasýnda)
int zar_atisi() {
    int timer_value = get_timer0();
    set_timer0(0);
    return (timer_value % 6) + 1; // 1-6 arasýnda sayý döner
}

// LED Efekti: Zar atýþý sýrasýnda kýsa efekt
void led_efekti() {
    for (int j = 0; j < 8; j++) {
        output_high(PIN_D0 + j);
        delay_ms(50);
        output_low(PIN_D0 + j);
    }
}

// Kazanan LED efekti
void kazanan_led_efekti() {
    for (int i = 0; i < 3; i++) {  // 3 kez tekrarla
        for (int j = 0; j < 8; j++) output_high(PIN_D0 + j);
        delay_ms(200);
        for (int j = 0; j < 8; j++) output_low(PIN_D0 + j);
        delay_ms(200);
    }
}

// Hoþgeldiniz mesajý hýzlý kayar
void hosgeldiniz_mesaji() {
    for (int pos = 17; pos > 0; pos--) {
        lcd_putc("\f");
        lcd_gotoxy(pos, 1);
        printf(lcd_putc, "Hosgeldiniz!");
        delay_ms(80);
    }
}

// Zar sonuçlarýný göster: Tüm P1 ve P2 deðerlerini ayný anda göster
void guncelle_lcd() {
    lcd_putc("\f");
    lcd_gotoxy(1, 1);
    printf(lcd_putc, "P1: ");
    for (int k = 0; k <= zar_sayisi; k++) {
        printf(lcd_putc, "%d", oyuncu1_zarlar[k]);
        if (k < zar_sayisi) printf(lcd_putc, "+");
    }

    lcd_gotoxy(1, 2);
    printf(lcd_putc, "P2: ");
    for (int k = 0; k <= zar_sayisi; k++) {
        printf(lcd_putc, "%d", oyuncu2_zarlar[k]);
        if (k < zar_sayisi) printf(lcd_putc, "+");
    }
}

// Kazanan mesajýný göster
void kazanan_mesaji() {
    lcd_putc("\f");
    lcd_gotoxy(1, 1);
    printf(lcd_putc, "P1: %d   P2: %d", oyuncu1_toplam, oyuncu2_toplam);
    delay_ms(2000);

    lcd_putc("\f");
    lcd_gotoxy(1, 1);
    if (oyuncu1_toplam > oyuncu2_toplam) {
        printf(lcd_putc, "P1 Kazandi!");
    } else if (oyuncu2_toplam > oyuncu1_toplam) {
        printf(lcd_putc, "P2 Kazandi!");
    } else {
        printf(lcd_putc, "Berabere!");
    }
    kazanan_led_efekti();
}

void main() {
    lcd_init();
    setup_timer_0(RTCC_INTERNAL | RTCC_DIV_256);
    set_tris_c(0x03);  // RC0 ve RC1 giriþ
    set_tris_d(0x00);  // RD0-RD7 çýkýþ (LED)
    set_tris_b(0x00);  // RB0-RB7 çýkýþ (LCD)

    while (TRUE) {
        // Lütfen Çalýþtýr Butonu Ekraný
        lcd_putc("\f");
        lcd_gotoxy(1, 1);
        printf(lcd_putc, "Lutfen Calistir");
        lcd_gotoxy(1, 2);
        printf(lcd_putc, "Butonuna Basin!");

        while (!input(PIN_C0)); // Çalýþtýr butonunu bekle
        delay_ms(200);

        hosgeldiniz_mesaji();
        lcd_putc("\f");
        lcd_gotoxy(1, 1);
        printf(lcd_putc, "Oyuna baslamak");
        lcd_gotoxy(1, 2);
        printf(lcd_putc, "icin START'a basin!");

        zar_sayisi = 0;
        oyuncu1_toplam = 0;
        oyuncu2_toplam = 0;

        while (zar_sayisi < 3) {
            // P1 Zar Atýþý
            while (!input(PIN_A0));
            delay_ms(200);
            oyuncu1_zarlar[zar_sayisi] = zar_atisi();
            oyuncu1_toplam += oyuncu1_zarlar[zar_sayisi];
            guncelle_lcd();
            led_efekti();

            // P2 Zar Atýþý
            while (!input(PIN_A0));
            delay_ms(200);
            oyuncu2_zarlar[zar_sayisi] = zar_atisi();
            oyuncu2_toplam += oyuncu2_zarlar[zar_sayisi];
            guncelle_lcd();
            led_efekti();

            zar_sayisi++;
        }

        kazanan_mesaji();

        // RESET Butonunu Bekle
        while (!input(PIN_C1));
        delay_ms(200);
    }
}

